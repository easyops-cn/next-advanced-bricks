import path from "node:path";
import { writeFile } from "node:fs/promises";
import { fileURLToPath } from "node:url";
import yaml from "js-yaml";

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const { safeDump, JSON_SCHEMA } = yaml;

export async function build() {
  const storyboard = (await import("../dist/index.js")).default;

  storyboard.meta = {
    ...storyboard.resources.meta,
    customTemplates: storyboard.components,
    functions: Object.values(storyboard.resources.functions),
    menus: storyboard.resources.menus,
    contracts: storyboard.resources.contracts,
    i18n: storyboard.resources.i18n,
  };
  delete storyboard.resources;
  delete storyboard.components;

  await Promise.all([
    writeFile(
      path.resolve(__dirname, __APP_RELATIVE_DIR__, "storyboard.yaml"),
      safeDump(storyboard, {
        indent: 2,
        schema: JSON_SCHEMA,
        skipInvalid: true,
        noRefs: true,
        noCompatMode: true,
      })
    ),
    writeFile(
      path.resolve(__dirname, __APP_RELATIVE_DIR__, "storyboard.json"),
      JSON.stringify(storyboard, null, 2)
    )
  ]);
}

build().then(() => {
  console.log("Build done!");
}, (err) => {
  console.error("Build failed:", err);
});
